<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>DitxCloud — Akun (Login / Register)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#041022; --panel:#07162a; --muted:#9fb6cc;
    --accent1:#7c5cff; --accent2:#00d4ff; --glass: rgba(255,255,255,0.03);
    font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    color-scheme: dark; color:#e6f4ff;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:
    radial-gradient(800px 300px at 10% 12%, rgba(124,92,255,0.06), transparent 8%),
    linear-gradient(180deg,#000814 0%, var(--bg) 40%); -webkit-font-smoothing:antialiased}
  a{color:inherit}
  .topbar{
    height:72px;display:flex;align-items:center;gap:12px;padding:12px 20px;border-bottom:1px solid rgba(255,255,255,0.03);
    background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
  }
  .logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--accent1),var(--accent2));display:grid;place-items:center;font-weight:800}
  .brand{display:flex;flex-direction:column}
  .wrap{max-width:1100px;margin:24px auto;padding:0 18px}
  .card{
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:12px;padding:18px;border:1px solid rgba(255,255,255,0.03);
    box-shadow: 0 12px 40px rgba(0,0,0,0.5);
  }

  /* layout */
  .auth-layout{display:grid;grid-template-columns: 1fr 420px; gap:22px; align-items:start}
  .lead{font-size:22px;margin:0 0 10px 0}
  .muted{color:var(--muted);font-size:14px}

  /* forms */
  .field{margin-bottom:12px}
  input[type="text"], input[type="password"], input[type="email"]{
    width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;
  }
  .btn{padding:10px 14px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:white;cursor:pointer;font-weight:700}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--accent2)}

  .tabs{display:flex;gap:8px;margin-bottom:12px}
  .tab{padding:8px 12px;border-radius:8px;cursor:pointer;background:transparent;border:1px solid transparent;color:var(--muted)}
  .tab.active{background:linear-gradient(90deg, rgba(124,92,255,0.12), rgba(0,212,255,0.04));color:#fff;border-color:rgba(255,255,255,0.03)}

  .status{margin-top:12px;font-size:13px;color:var(--muted)}

  /* logged-in box */
  .logged{display:flex;flex-direction:column;gap:8px}
  .actions{display:flex;gap:8px}

  /* small responsive */
  @media (max-width:980px){
    .auth-layout{grid-template-columns:1fr}
  }
</style>
</head>
<body>

<div class="topbar">
  <div style="display:flex;gap:12px;align-items:center">
    <div class="logo">JC</div>
    <div class="brand">
      <div style="font-weight:800">DitxCloud</div>
      <div style="font-size:13px;color:var(--muted)">cPanel Jupiter — Akun</div>
    </div>
  </div>
  <div style="margin-left:auto" id="topActions"></div>
</div>

<div class="wrap">
  <div class="auth-layout">
    <!-- left: info -->
    <div>
      <div class="card">
        <h2 class="lead">Selamat datang di DitxCloud</h2>
        <p class="muted">Panel hosting ala cPanel (Jupiter). Buat akun, login, lalu buka dashboard terpisah (dashboard.html). Data user disimpan pada Firebase Realtime Database sebagai JSON.</p>

        <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0">

        <h4 style="margin:0 0 6px 0">Keunggulan</h4>
        <ul class="muted">
          <li>File manager, email (simulasi), database & domain — seluruh metadata di JSON</li>
          <li>Proteksi session & password hashed (SHA-256)</li>
          <li>Desain modern, responsive, dan mudah diintegrasikan dengan dashboard terpisah</li>
        </ul>
      </div>

      <div style="margin-top:16px" class="card">
        <h4 style="margin:0 0 8px 0">Panduan singkat</h4>
        <ol class="muted" style="margin:0;padding-left:18px">
          <li>Daftar akun baru (domain unik)</li>
          <li>Login — sistem membuat session di Firebase</li>
          <li>Buka <code>dashboard.html</code> untuk mengelola fitur lengkap</li>
        </ol>
      </div>
    </div>

    <!-- right: auth card -->
    <div>
      <div class="card" id="authCard">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:700">Masuk / Buat Akun</div>
            <div class="muted" style="font-size:13px">Akses dashboard hosting kamu setelah login</div>
          </div>
        </div>

        <div style="margin-top:14px">
          <div class="tabs">
            <div id="tab-register" class="tab active" onclick="switchTab('register')">Register</div>
            <div id="tab-login" class="tab" onclick="switchTab('login')">Login</div>
          </div>

          <!-- REGISTER -->
          <div id="box-register">
            <div class="field"><input id="reg_name" type="text" placeholder="Nama lengkap (contoh: Adit Dev)"></div>
            <div class="field"><input id="reg_domain" type="text" placeholder="Domain unik (contoh: adit) — akan jadi username"></div>
            <div class="field"><input id="reg_pw" type="password" placeholder="Password (min 6)"></div>
            <div class="field"><input id="reg_addr" type="text" placeholder="Alamat (kota, negara)"></div>
            <div style="display:flex;gap:8px">
              <button class="btn" onclick="doRegister()">Daftar & Masuk</button>
              <button class="btn ghost" onclick="switchTab('login')">Punya akun? Login</button>
            </div>
            <div id="regStatus" class="status"></div>
          </div>

          <!-- LOGIN -->
          <div id="box-login" style="display:none">
            <div class="field"><input id="login_domain" type="text" placeholder="Domain (contoh: adit)"></div>
            <div class="field"><input id="login_pw" type="password" placeholder="Password"></div>
            <div style="display:flex;gap:8px">
              <button class="btn" onclick="doLogin()">Login</button>
              <button class="btn ghost" onclick="switchTab('register')">Daftar baru</button>
            </div>
            <div id="loginStatus" class="status"></div>
          </div>

          <!-- Already logged in -->
          <div id="box-logged" style="display:none;margin-top:12px">
            <div class="logged">
              <div style="font-weight:700" id="loggedUser">Anda masuk sebagai: —</div>
              <div class="muted" id="loggedDomain">Domain: —</div>
              <div class="actions" style="margin-top:8px">
                <button class="btn" id="goDashBtn" onclick="goDashboard()">Buka Dashboard</button>
                <button class="btn ghost" onclick="logout()">Logout</button>
              </div>
              <div id="sessionInfo" class="status"></div>
            </div>
          </div>

        </div>

        <div class="status" style="margin-top:12px">Catatan: Password akan disimpan sebagai hash (SHA-256). Untuk keamanan produksi, gunakan Firebase Auth atau server-side verification.</div>
      </div>
    </div>
  </div>
</div>

<script>
/*
 akun.html (auth-only)
 - terpisah dari dashboard; setelah login redirect ke dashboard.html
 - menggunakan Firebase Realtime DB REST API (DB_URL di bawah)
 - menyimpan sessions di /sessions/{token}
 - menyimpan user di /users/{domain}
*/

// === CONFIG ===
const DB_URL = "https://ditxcloud-default-rtdb.asia-southeast1.firebasedatabase.app";
const SESSION_TTL = 1000 * 60 * 60 * 24 * 7; // 7 hari
const LOGIN_MAX_ATTEMPTS = 5;
const LOCKOUT_MS = 1000 * 60 * 5; // 5 menit

// === state & helpers ===
let state = { sessionToken: null, domain: null };

function jq(path){ return `${DB_URL}/${path}.json`; }
async function safeFetch(url, opts={}){ try{ const r = await fetch(url, opts); if(r.ok){ try{ return await r.json(); }catch(e){ return null; } } if(r.status === 204) return null; return null; }catch(e){ return null; } }
function randToken(len=28){ const arr = new Uint8Array(len); crypto.getRandomValues(arr); return Array.from(arr).map(b=>b.toString(16).padStart(2,'0')).join(''); }
async function sha256Hex(str){ const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str)); return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join(''); }
function now(){ return Date.now(); }
function setSessionLocal(token){ localStorage.setItem('ditx_session', token); state.sessionToken = token; }
function clearSessionLocal(){ localStorage.removeItem('ditx_session'); state.sessionToken = null; state.domain = null; }

// simple UI helpers
function $(id){ return document.getElementById(id); }
function switchTab(t){
  if(t==='login'){ $('box-login').style.display=''; $('box-register').style.display='none'; $('tab-login').classList.add('active'); $('tab-register').classList.remove('active'); }
  else { $('box-login').style.display='none'; $('box-register').style.display=''; $('tab-login').classList.remove('active'); $('tab-register').classList.add('active'); }
  $('regStatus').innerText=''; $('loginStatus').innerText='';
}

// === RATE LIMIT (simple, per-browser) ===
function getLoginMeta(domain){
  try{ const raw = sessionStorage.getItem('login_meta_'+domain); return raw?JSON.parse(raw):{fails:0,lockedUntil:0}; }catch(e){ return {fails:0,lockedUntil:0}; }
}
function setLoginMeta(domain, meta){ sessionStorage.setItem('login_meta_'+domain, JSON.stringify(meta)); }

// === session management ===
async function createSession(domain){
  const token = randToken(24);
  const expires = Date.now() + SESSION_TTL;
  await fetch(jq(`sessions/${token}`), { method: 'PUT', body: JSON.stringify({ domain, expires }) });
  setSessionLocal(token);
  return token;
}
async function verifySessionLocal(){
  const token = localStorage.getItem('ditx_session');
  if(!token) return false;
  const s = await safeFetch(jq(`sessions/${token}`));
  if(!s) { clearSessionLocal(); return false; }
  if(s.expires < Date.now()){ await fetch(jq(`sessions/${token}`), { method:'DELETE' }).catch(()=>{}); clearSessionLocal(); return false; }
  state.sessionToken = token; state.domain = s.domain; return true;
}

// === AUTH: register & login ===
async function doRegister(){
  $('regStatus').innerText = 'Memproses...';
  const nama = ($('reg_name').value||'').trim();
  const domain = ($('reg_domain').value||'').trim().toLowerCase();
  const pw = $('reg_pw').value||'';
  const addr = ($('reg_addr').value||'').trim();
  if(!nama || !domain || !pw || !addr){ $('regStatus').innerText='Lengkapi semua field'; return; }
  if(pw.length < 6){ $('regStatus').innerText='Password minimal 6 karakter'; return; }
  if(!/^[a-z0-9\-_]{3,36}$/.test(domain)){ $('regStatus').innerText='Domain hanya huruf kecil/angka/-/_ (3-36)'; return; }

  const existing = await safeFetch(jq(`users/${domain}`));
  if(existing){ $('regStatus').innerText='Domain sudah terpakai'; return; }

  const hash = await sha256Hex(pw);
  const payload = {
    profile: { nama, domain, alamat: addr, createdAt: Date.now() },
    auth: { passwordHash: hash },
    quota: { limitBytes: 500*1024, usedBytes: 0 },
    files: {}, email: {}, databases: {}, domains: {}, metrics: {}, security: {}, software: {}, logs: {}
  };

  await fetch(jq(`users/${domain}`), { method:'PUT', body: JSON.stringify(payload) });
  await createSession(domain);
  // log minimal
  await fetch(jq(`logs/${domain}/${Date.now()}`), { method:'PUT', body: JSON.stringify({ action:'register', time:Date.now() }) });
  state.domain = domain;
  $('regStatus').innerText = 'Registrasi berhasil — redirect ke dashboard...';
  setTimeout(()=>{ window.location.href = 'dashboard.html'; }, 900);
}

async function doLogin(){
  $('loginStatus').innerText = 'Memproses...';
  const domain = ($('login_domain').value||'').trim().toLowerCase();
  const pw = $('login_pw').value||'';
  if(!domain || !pw){ $('loginStatus').innerText='Isi domain & password'; return; }

  // check lockout
  const meta = getLoginMeta(domain);
  if(meta.lockedUntil && meta.lockedUntil > now()){ const remain = Math.ceil((meta.lockedUntil - now())/1000); $('loginStatus').innerText = `Terlalu banyak percobaan. Coba lagi dalam ${remain}s`; return; }

  const profile = await safeFetch(jq(`users/${domain}`));
  if(!profile){ $('loginStatus').innerText='Domain tidak ditemukan'; meta.fails = (meta.fails||0)+1; setLoginMeta(domain, meta); return; }
  const hash = await sha256Hex(pw);
  const stored = (profile.auth && profile.auth.passwordHash) ? profile.auth.passwordHash : profile.password;
  if(stored !== hash){
    meta.fails = (meta.fails||0)+1;
    if(meta.fails >= LOGIN_MAX_ATTEMPTS){ meta.lockedUntil = Date.now() + LOCKOUT_MS; meta.fails = 0; $('loginStatus').innerText = `Terlalu banyak percobaan. Terkunci ${Math.floor(LOCKOUT_MS/60000)} menit.`; }
    else { $('loginStatus').innerText = `Password salah (${meta.fails}/${LOGIN_MAX_ATTEMPTS})`; }
    setLoginMeta(domain, meta);
    return;
  }

  // success
  setLoginMeta(domain, {fails:0, lockedUntil:0});
  await createSession(domain);
  await fetch(jq(`logs/${domain}/${Date.now()}`), { method:'PUT', body: JSON.stringify({ action:'login', time:Date.now() }) });
  $('loginStatus').innerText = 'Login sukses — redirect ke dashboard...';
  state.domain = domain;
  setTimeout(()=>{ window.location.href = 'dashboard.html'; }, 700);
}

// === when already logged in: quick actions ===
async function updateLoggedUI(){
  const ok = await verifySessionLocal();
  if(!ok){ $('box-logged').style.display='none'; $('authCard').style.display=''; return; }
  // show logged box
  $('box-logged').style.display=''; $('authCard').style.display='';
  $('box-register').style.display='none'; $('box-login').style.display='none';
  $('tab-register').classList.remove('active'); $('tab-login').classList.remove('active');
  // fetch profile for name
  const profile = await safeFetch(jq(`users/${state.domain}/profile`)) || await safeFetch(jq(`users/${state.domain}`));
  const name = profile?.nama || profile?.profile?.nama || state.domain;
  $('loggedUser').innerText = `Anda masuk sebagai: ${name}`;
  $('loggedDomain').innerText = `Domain: ${state.domain}.ditxcloud`;
  $('sessionInfo').innerText = `Session aktif — token: ${state.sessionToken?.slice(0,8)}…`;
}

// === logout ===
async function logout(){
  const token = localStorage.getItem('ditx_session');
  if(token) await fetch(jq(`sessions/${token}`), { method:'DELETE' }).catch(()=>{});
  clearSessionLocal();
  // show login/register again
  $('box-logged').style.display='none';
  switchTab('login');
  $('loginStatus').innerText = 'Anda telah logout.';
}

// === go to dashboard (separate file) ===
function goDashboard(){
  // dashboard should check session on load (we created it here)
  window.location.href = 'dashboard.html';
}

// === init ===
(async function init(){
  // set initial UI
  switchTab('register');
  // check session
  const ok = await verifySessionLocal();
  if(ok){
    // show logged state, not the forms
    $('authCard').scrollIntoView();
    await updateLoggedUI();
    $('authCard').style.border = '1px solid rgba(0,200,255,0.06)';
  }
})();
</script>

</body>
</html>
